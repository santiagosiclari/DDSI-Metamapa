<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Solicitudes · Metamapa</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
        <a class="navbar-brand" th:href="@{/metamapa}">Metamapa</a>
        <div class="navbar-nav">
            <a class="nav-link active" th:href="@{/metamapa/solicitudes}">Solicitudes</a>
        </div>
    </div>
</nav>

<main class="container">
    <h1 class="mb-3">Gestión de solicitudes</h1>
    <p class="text-muted">Crear, consultar y resolver solicitudes de <strong>eliminación</strong> y <strong>edición</strong>.</p>

    <ul class="nav nav-tabs" id="tabsSolicitudes" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-eliminar" data-bs-toggle="tab" data-bs-target="#pane-eliminar"
                    type="button" role="tab">Crear solicitud de eliminación</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-editar" data-bs-toggle="tab" data-bs-target="#pane-editar"
                    type="button" role="tab">Crear solicitud de edición</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-resolver" data-bs-toggle="tab" data-bs-target="#pane-resolver"
                    type="button" role="tab">Consultar / Resolver</button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-3 bg-white rounded-bottom">

        <!-- === Crear solicitud de eliminación === -->
        <div class="tab-pane fade show active" id="pane-eliminar" role="tabpanel" aria-labelledby="tab-eliminar">
            <form id="formEliminar" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">ID Hecho afectado</label>
                    <input type="number" class="form-control" name="idHechoAfectado" required/>
                </div>
                <div class="col-md-8">
                    <label class="form-label">Motivo</label>
                    <input type="text" class="form-control" name="motivo" maxlength="255" required/>
                </div>
                <div class="col-md-12">
                    <label class="form-label">URL (opcional)</label>
                    <input type="url" class="form-control" name="url" placeholder="https://..."/>
                </div>
                <div class="col-12">
                    <button class="btn btn-primary" type="submit">Crear solicitud</button>
                </div>
            </form>
            <div id="respEliminar" class="mt-3"></div>
        </div>

        <!-- === Crear solicitud de edición === -->
        <div class="tab-pane fade" id="pane-editar" role="tabpanel" aria-labelledby="tab-editar">
            <form id="formEditar" class="row g-3">
                <div class="col-md-12">
                    <label class="form-label">Hecho afectado</label>
                    <input type="text" class="form-control" name="hechoAfectado" required/>
                </div>
                <div class="col-md-12">
                    <label class="form-label">Motivo</label>
                    <input type="text" class="form-control" name="motivo" required/>
                </div>
                <div class="col-md-12">
                    <label class="form-label">URL (opcional)</label>
                    <input type="url" class="form-control" name="url" placeholder="https://..."/>
                </div>
                <div class="col-12">
                    <button class="btn btn-primary" type="submit">Crear solicitud</button>
                </div>
            </form>
            <div id="respEditar" class="mt-3"></div>
        </div>

        <!-- === Consultar / Resolver solicitudes de eliminación === -->
        <div class="tab-pane fade" id="pane-resolver" role="tabpanel" aria-labelledby="tab-resolver">
            <form id="formBuscar" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">ID Solicitud</label>
                    <input type="number" class="form-control" name="id" required/>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-secondary" type="submit">Buscar</button>
                </div>
            </form>

            <div id="panelDetalle" class="mt-3 d-none">
                <h5>Detalle</h5>
                <pre class="border rounded p-3 bg-light" id="jsonDetalle"></pre>

                <div class="d-flex gap-2 mt-3">
                    <button id="btnAprobar" class="btn btn-success">Aprobar</button>
                    <button id="btnRechazar" class="btn btn-danger">Rechazar</button>
                </div>

                <div id="respResolver" class="mt-3"></div>
            </div>
        </div>

    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Helper CSRF (si aplica)
    function csrfHeaders(h = {}) {
        const token = document.querySelector('meta[name="_csrf"]')?.content;
        const header = document.querySelector('meta[name="_csrf_header"]')?.content;
        if (token && header) h[header] = token;
        return h;
    }

    // === Crear eliminación ===
    document.getElementById('formEliminar').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = {
            idHechoAfectado: Number(fd.get('idHechoAfectado')),
            motivo: fd.get('motivo'),
            url: fd.get('url') || null
        };

        const resp = document.getElementById('respEliminar');
        resp.innerHTML = '<div class="alert alert-info">Creando...</div>';

        try {
            const r = await fetch('/metamapa/api/solicitudesEliminacion', {
                method: 'POST',
                headers: csrfHeaders({'Content-Type': 'application/json'}),
                body: JSON.stringify(payload)
            });

            if (r.status === 201) {
                const data = await r.json();
                const loc = r.headers.get('Location') || ('/metamapa/api/solicitudesEliminacion/' + data.id);
                resp.innerHTML =
                    `<div class="alert alert-success">
             Creada ✔ — ID: <strong>${data.id}</strong><br/>
             <a href="${loc}">${loc}</a>
           </div>`;
            } else {
                const text = await r.text();
                resp.innerHTML = `<div class="alert alert-warning">Respuesta ${r.status}: ${text}</div>`;
            }
        } catch (err) {
            resp.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
        }
    });

    // === Crear edición (@RequestParam -> form-urlencoded) ===
    document.getElementById('formEditar').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const params = new URLSearchParams();
        params.set('hechoAfectado', fd.get('hechoAfectado'));
        params.set('motivo', fd.get('motivo'));
        if (fd.get('url')) params.set('url', fd.get('url'));

        const resp = document.getElementById('respEditar');
        resp.innerHTML = '<div class="alert alert-info">Creando...</div>';

        try {
            const r = await fetch('/metamapa/solicitudesEdicion/', {
                method: 'POST',
                headers: csrfHeaders({'Content-Type': 'application/x-www-form-urlencoded'}),
                body: params.toString()
            });

            if (r.status === 201) {
                const data = await r.json();
                const loc = r.headers.get('Location') || ('/metamapa/solicitudesEdicion/' + data.id);
                resp.innerHTML =
                    `<div class="alert alert-success">
             Creada ✔ — ID: <strong>${data.id}</strong><br/>
             <a href="${loc}">${loc}</a>
           </div>`;
            } else {
                const text = await r.text();
                resp.innerHTML = `<div class="alert alert-warning">Respuesta ${r.status}: ${text}</div>`;
            }
        } catch (err) {
            resp.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
        }
    });

    // === Consultar / Resolver (solicitudes de eliminación) ===
    let solicitudIdActual = null;

    document.getElementById('formBuscar').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const id = Number(fd.get('id'));
        solicitudIdActual = id;

        const panel = document.getElementById('panelDetalle');
        const pre = document.getElementById('jsonDetalle');
        const resp = document.getElementById('respResolver');
        resp.innerHTML = '';
        pre.textContent = 'Buscando...';
        panel.classList.remove('d-none');

        try {
            const r = await fetch(`/metamapa/api/solicitudesEliminacion/${id}`, { headers: csrfHeaders() });
            if (r.ok) {
                const data = await r.json();
                pre.textContent = JSON.stringify(data, null, 2);
            } else if (r.status === 404) {
                pre.textContent = 'No encontrada (404).';
            } else {
                pre.textContent = `Respuesta ${r.status}: ${await r.text()}`;
            }
        } catch (err) {
            pre.textContent = `Error: ${err}`;
        }
    });

    document.getElementById('btnAprobar').addEventListener('click', () => resolver('APROBAR'));
    document.getElementById('btnRechazar').addEventListener('click', () => resolver('RECHAZAR'));

    async function resolver(accion) {
        if (!solicitudIdActual) return;
        const resp = document.getElementById('respResolver');
        resp.innerHTML = `<div class="alert alert-info">Enviando acción: ${accion}...</div>`;
        try {
            const r = await fetch(`/metamapa/api/solicitudesEliminacion/${solicitudIdActual}`, {
                method: 'PATCH',
                headers: csrfHeaders({'Content-Type': 'application/json'}),
                body: JSON.stringify({ accion })
            });

            if (r.status === 204) {
                resp.innerHTML = `<div class="alert alert-success">OK (204): solicitud resuelta (${accion}).</div>`;
            } else if (r.status === 404) {
                resp.innerHTML = `<div class="alert alert-warning">No encontrada (404)</div>`;
            } else if (r.status === 409) {
                resp.innerHTML = `<div class="alert alert-warning">Conflicto (409): ya estaba resuelta.</div>`;
            } else if (r.status === 422) {
                resp.innerHTML = `<div class="alert alert-warning">Acción inválida (422)</div>`;
            } else {
                resp.innerHTML = `<div class="alert alert-warning">Respuesta ${r.status}: ${await r.text()}</div>`;
            }
        } catch (err) {
            resp.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
        }
    }
</script>
</body>
</html>
